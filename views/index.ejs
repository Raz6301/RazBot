<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>לוח בקרה - RazBot</title>
  <link rel="stylesheet" href="/style.css">
  <style>
    section.dashboard-card {
      display: none;
    }
    section.dashboard-card.show {
      display: block;
    }
    .button.small {
      font-size: 0.8rem;
      padding: 4px 8px;
      margin: 0 4px;
      border-radius: 6px;
      cursor: pointer;
    }
    .reroll {
      background-color: #ffcc00;
      color: black;
    }
    .end {
      background-color: #ff4444;
      color: white;
    }
  </style>
</head>
<body>
  <!-- Top bar with language and theme toggles -->
  <header class="topbar">
    <!-- Hamburger menu toggle for mobile -->
    <button id="menuToggle">☰</button>
    <button id="langToggle"><%= lang === 'en' ? 'עברית' : 'English' %></button>
    <button id="themeToggle"><%= lang === 'en' ? 'Dark/Light' : 'בהיר/כהה' %></button>
  </header>

  <div class="container">
    <aside class="sidebar">
      <h2>🧱 תפריט</h2>
      <ul>
        <li><a href="#stats"> <%= t.menu.stats %> </a></li>
        <li><a href="#giveaways"> <%= t.menu.giveaways %> </a></li>
        <li><a href="#filters"> <%= t.menu.filters %> </a></li>
        <li><a href="#tickets"> <%= t.menu.tickets %> </a></li>
        <li><a href="#invites"> <%= t.menu.invites %> </a></li>
      </ul>
    </aside>

    <main class="main">
      <section id="stats" class="dashboard-card">
        <h2><%= t.sections.statsTitle %></h2>
        <div class="stats-box">
          <div class="stat"><strong><%= stats.users %></strong> משתמשים</div>
          <div class="stat"><strong><%= stats.channels %></strong> חדרים</div>
          <div class="stat"><strong><%= stats.roles %></strong> רולים</div>
        </div>

        <!-- תצוגת גרף סטטיסטיקות באמצעות Chart.js -->
        <canvas id="statsChart" width="400" height="200" style="margin-top: 20px;"></canvas>
      </section>

      <section id="giveaways" class="dashboard-card">
        <h2><%= t.sections.createGiveawayTitle %></h2>
        <form method="POST" action="/start-giveaway?lang=<%= lang %>">
          <input type="text" name="giveawayChannel" placeholder="<%= lang === 'en' ? 'Channel name' : 'שם החדר' %>">
          <input type="text" name="giveawayDuration" placeholder="<%= lang === 'en' ? 'Duration (10m, 1h)' : 'משך ההגרלה (10m, 1h)' %>">
          <input type="number" name="giveawayWinners" placeholder="<%= lang === 'en' ? 'Number of winners' : 'מספר זוכים' %>">
          <input type="text" name="giveawayPrize" placeholder="<%= lang === 'en' ? 'Prize' : 'הפרס' %>">
          <button type="submit"><%= t.actions.startGiveaway %></button>
        </form>

        <h3><%= t.sections.activeGiveawaysTitle %></h3>
        <ul id="activeGiveawaysList"><li>טוען...</li></ul>

        <hr>

        <h3><%= t.sections.endedGiveawaysTitle %></h3>
        <ul id="endedGiveawaysList"><li>טוען...</li></ul>
      </section>

      <!-- Removed messages section -->

      <section id="filters" class="dashboard-card">
        <h2><%= t.sections.filtersTitle %></h2>
        <form method="POST" action="/toggle-blockLinks?lang=<%= lang %>">
          <button type="submit"><%= lang === 'en' ? 'Links: ' : 'לינקים: ' %><%= config.blockLinks ? (lang === 'en' ? 'Enabled' : 'מופעל') : (lang === 'en' ? 'Disabled' : 'כבוי') %></button>
        </form>
        <form method="POST" action="/toggle-blockPings?lang=<%= lang %>">
          <button type="submit"><%= lang === 'en' ? 'Pings: ' : 'פינגים: ' %><%= config.blockPings ? (lang === 'en' ? 'Enabled' : 'מופעל') : (lang === 'en' ? 'Disabled' : 'כבוי') %></button>
        </form>
        <form method="POST" action="/add-badword?lang=<%= lang %>">
          <input type="text" name="word" placeholder="<%= lang === 'en' ? 'Add a forbidden word' : 'הוסף מילה אסורה' %>">
          <button type="submit"><%= t.actions.addForbiddenWord %></button>
        </form>
      </section>

      <section id="tickets" class="dashboard-card">
        <h2><%= t.sections.ticketsTitle %></h2>
        <!-- Form to create a ticket button -->
        <form method="POST" action="/send-ticket-button?lang=<%= lang %>">
          <input type="text" name="ticketChannel" placeholder="<%= lang === 'en' ? 'Channel name' : 'שם החדר' %>">
          <input type="text" name="ticketMessage" placeholder="<%= lang === 'en' ? 'Message text' : 'תוכן ההודעה' %>">
          <input type="text" name="closedCategory" placeholder="<%= lang === 'en' ? 'Closed tickets category name' : 'שם הקטגוריה לטיקטים סגורים' %>">
          <button type="submit"><%= t.actions.sendTicket %></button>
        </form>
        <h3><%= lang === 'en' ? 'Closed tickets' : 'טיקטים סגורים' %></h3>
        <ul id="ticketsList"><li><%= lang === 'en' ? 'Loading tickets...' : 'טוען טיקטים...' %></li></ul>
      </section>

      <section id="invites" class="dashboard-card">
        <h2><%= t.sections.invitesTitle %></h2>
        <ul id="invitesList"><li><%= lang === 'en' ? 'Loading...' : 'טוען...' %></li></ul>
      </section>
    </main>
  </div>

  <!-- Modal for displaying closed ticket messages -->
  <div id="ticketModal" style="display:none; position:fixed; top:0; right:0; bottom:0; left:0; background: rgba(0,0,0,0.6); align-items:center; justify-content:center; z-index:2000;">
    <div style="background: var(--card-bg); padding: 20px; border-radius: 12px; max-width: 80%; max-height: 80%; overflow-y: auto; color: var(--text-color); position: relative;">
      <button id="closeTicketModal" style="position:absolute; top:10px; left:10px; background:none; border:none; color: var(--text-color); font-size:24px; cursor:pointer;">×</button>
      <pre id="ticketContent" style="white-space: pre-wrap;"></pre>
    </div>
  </div>

  <script>
    // טען את ספריית Chart.js
    // Note: Chart.js נטען באמצעות CDN בהמשך (ראו בהמשך).
    async function fetchGiveaways() {
      try {
        const res = await fetch("/api/giveaways");
        const giveaways = await res.json();
        const active = giveaways.filter(g => !g.ended);
        const ended = giveaways.filter(g => g.ended);
        const activeList = document.getElementById("activeGiveawaysList");
        const endedList = document.getElementById("endedGiveawaysList");
        activeList.innerHTML = active.length === 0 ? "<li>אין כרגע הגרלות פעילות.</li>" : "";
        endedList.innerHTML = ended.length === 0 ? "<li>אין עדיין הגרלות שהסתיימו.</li>" : "";
        active.forEach(g => {
          activeList.innerHTML += `<li><strong>🎁 ${g.prize}</strong> | זוכים: ${g.winnerCount} | מסתיימת: ${new Date(g.endAt).toLocaleString("he-IL")}
    <form method="POST" action="/reroll-giveaway/${g.messageId}" style="display:inline;">
      <button class="button small reroll">🎲 רירול</button>
    </form>
    <form method="POST" action="/end-giveaway/${g.messageId}" style="display:inline;">
      <button class="button small end">⛔ סיום</button>
    </form>
    <button type="button" class="button small extend" data-id="${g.messageId}">⌛ הארך</button>
          </li>`;
        });
      ended.forEach(g => {
  endedList.innerHTML += `
    <li>
      <strong>🎁 ${g.prize}</strong> | זוכים: ${g.winnerCount} | הסתיימה: ${new Date(g.endAt).toLocaleString("he-IL")}
      <form method="POST" action="/reroll-giveaway/${g.messageId}" style="display:inline;">
        <button class="button small reroll">🎲 רירול</button>
      </form>
      <form method="POST" action="/delete-giveaway" style="display:inline;">
        <input type="hidden" name="giveawayId" value="${g.messageId}">
        <button class="button small delete">🗑️ מחק</button>
      </form>
    </li>`;
});

      } catch (err) {
        console.error("שגיאה בטעינת הגרלות:", err);
      }
    }

    async function fetchInvites() {
      try {
        const res = await fetch("/api/invites");
        const invites = await res.json();
        const list = document.getElementById("invitesList");
        list.innerHTML = invites.length === 0 ? "<li>אין נתוני הזמנות זמינים.</li>" : "";
        invites.forEach(i => {
          list.innerHTML += `<li><strong>${i.username}</strong> הזמין ${i.count} משתמשים</li>`;
        });
      } catch (err) {
        console.error("שגיאה בטעינת הזמנות:", err);
      }
    }

    async function fetchTickets() {
      try {
        const res = await fetch('/api/tickets');
        const tickets = await res.json();
        const list = document.getElementById('ticketsList');
        if (!list) return;
        list.innerHTML = tickets.length === 0
          ? `<li><%= lang === 'en' ? 'No closed tickets.' : 'אין טיקטים סגורים.' %></li>`
          : '';
        tickets.forEach(t => {
          // encode messages for dataset to avoid HTML issues
          const encoded = encodeURIComponent(t.messages);
          list.innerHTML += `<li><button type="button" class="ticket-item" data-msg="${encoded}">${t.user} - ${t.channel}</button></li>`;
        });
        document.querySelectorAll('.ticket-item').forEach(btn => {
          btn.addEventListener('click', () => {
            const decoded = decodeURIComponent(btn.getAttribute('data-msg'));
            const modal = document.getElementById('ticketModal');
            const content = document.getElementById('ticketContent');
            content.textContent = decoded;
            modal.style.display = 'flex';
          });
        });
      } catch (err) {
        console.error('שגיאה בטעינת טיקטים:', err);
      }
    }
    document.addEventListener("DOMContentLoaded", () => {
      const links = document.querySelectorAll(".sidebar a");
      const saved = localStorage.getItem("lastSection") || "stats";
      showSection(saved);
      links.forEach(link => link.addEventListener("click", e => {
        e.preventDefault();
        showSection(link.getAttribute("href").substring(1));
      }));
      fetchGiveaways();
      fetchInvites();
      fetchStatsChart();
      fetchTickets();
    });

    function showSection(id) {
      document.querySelectorAll(".dashboard-card").forEach(sec => sec.classList.remove("show"));
      const target = document.getElementById(id);
      if (target) target.classList.add("show");
      history.replaceState(null, null, `#${id}`);
      localStorage.setItem("lastSection", id);
    }

    async function fetchStatsChart() {
      try {
        const res = await fetch("/api/stats");
        const stats = await res.json();
        const ctx = document.getElementById("statsChart").getContext("2d");
        // הרס את הגרף הקודם אם הוא קיים
        if (window.statsChart) {
          window.statsChart.destroy();
        }
        window.statsChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: ['משתמשים', 'חדרים', 'רולים'],
            datasets: [{
              label: 'כמות',
              data: [stats.users, stats.channels, stats.roles],
              backgroundColor: ['#44ff44', '#ffaa00', '#00ccff'],
              borderColor: ['#44ff44', '#ffaa00', '#00ccff'],
              borderWidth: 1
            }]
          },
          options: {
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  color: '#fff'
                },
                grid: {
                  color: 'rgba(255,255,255,0.1)'
                }
              },
              x: {
                ticks: {
                  color: '#fff'
                },
                grid: {
                  color: 'rgba(255,255,255,0.1)'
                }
              }
            },
            plugins: {
              legend: {
                labels: {
                  color: '#fff'
                }
              }
            }
          }
        });
      } catch (err) {
        console.error('שגיאה בטעינת סטטיסטיקות:', err);
      }
    }
  </script>

  <!-- טעינת ספריית Chart.js מה‑CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- טעינת לקוח Socket.io כדי להתחבר לשרת בזמן אמת -->
  <script src="/socket.io/socket.io.js"></script>

  <!-- Toggle theme and language script -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const themeToggle = document.getElementById('themeToggle');
      const langToggle = document.getElementById('langToggle');
      const menuToggleBtn = document.getElementById('menuToggle');
      const sidebarEl = document.querySelector('.sidebar');
      const root = document.documentElement;
      // Restore saved theme preference or default to dark
      const savedTheme = localStorage.getItem('theme') || 'dark';
      root.setAttribute('data-theme', savedTheme);
      // Switch between dark and light themes
      if (themeToggle) {
        themeToggle.addEventListener('click', () => {
          const current = root.getAttribute('data-theme') || 'dark';
          const newTheme = current === 'dark' ? 'light' : 'dark';
          root.setAttribute('data-theme', newTheme);
          localStorage.setItem('theme', newTheme);
        });
      }
      // Switch between Hebrew and English by updating the query parameter
      if (langToggle) {
        langToggle.addEventListener('click', () => {
          const currentLang = '<%= lang %>';
          const newLang = currentLang === 'en' ? 'he' : 'en';
          const url = new URL(window.location.href);
          url.searchParams.set('lang', newLang);
          window.location.href = url.toString();
        });
      }

      // Toggle sidebar visibility on mobile when hamburger is clicked
      if (menuToggleBtn && sidebarEl) {
        menuToggleBtn.addEventListener('click', () => {
          sidebarEl.classList.toggle('open');
        });
      }

      // Close ticket modal on close button click
      const closeTicketModalBtn = document.getElementById('closeTicketModal');
      const ticketModal = document.getElementById('ticketModal');
      if (closeTicketModalBtn && ticketModal) {
        closeTicketModalBtn.addEventListener('click', () => {
          ticketModal.style.display = 'none';
        });
      }

      // Hide modal when clicking on the overlay itself (outside modal content)
      if (ticketModal) {
        ticketModal.addEventListener('click', ev => {
          if (ev.target === ticketModal) {
            ticketModal.style.display = 'none';
          }
        });
      }

      // Handle extend giveaway buttons globally
      document.addEventListener('click', async function(ev) {
        const target = ev.target;
        if (target.classList.contains('extend')) {
          const id = target.getAttribute('data-id');
          // Ask user for additional time to extend
          const promptMsg = '<%= lang === "en" ? "Enter additional time (e.g., 10m, 1h, 1d):" : "הזן זמן נוסף (למשל 10m, 1h, 1d):" %>';
          const additional = prompt(promptMsg);
          if (!additional) return;
          const formData = new FormData();
          formData.append('time', additional);
          const resp = await fetch(`/extend-giveaway/${id}`, { method: 'POST', body: formData });
          if (resp.ok) {
            alert('<%= lang === "en" ? "Giveaway extended" : "ההגרלה הוארכה" %>');
            fetchGiveaways();
          } else {
            alert('<%= lang === "en" ? "Failed to extend giveaway" : "כשל בהארכת ההגרלה" %>');
          }
        }
      });
    });
  </script>

  <!-- Socket.io real-time updates -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const socket = io();
      // קבל עדכון סטטיסטיקות ושדרג את התצוגה והגרף
      socket.on('stats', stats => {
        // עדכן את הערכים בכרטיסייה
        const statsElements = document.querySelectorAll('#stats .stat strong');
        if (statsElements.length >= 3) {
          statsElements[0].textContent = stats.users;
          statsElements[1].textContent = stats.channels;
          statsElements[2].textContent = stats.roles;
        }
        // עדכן את הגרף אם קיים
        if (window.statsChart) {
          window.statsChart.data.datasets[0].data = [stats.users, stats.channels, stats.roles];
          window.statsChart.update();
        }
      });
      // קבל עדכון הזמנות ושדרג את רשימת ההזמנות
      socket.on('invites', invites => {
        const list = document.getElementById('invitesList');
        if (!list) return;
        list.innerHTML = invites.length === 0 ? "<li><%= lang === 'en' ? 'No invite data available.' : 'אין נתוני הזמנות זמינים.' %></li>" : "";
        invites.forEach(i => {
          list.innerHTML += `<li><strong>${i.username}</strong> הזמין ${i.count} משתמשים</li>`;
        });
      });

      // קבל עדכוני הגרלות ושדרג את רשימת ההגרלות הפעילות והסתיימו
      socket.on('giveaways', data => {
        const active = data.active || [];
        const ended = data.ended || [];
        const activeList = document.getElementById('activeGiveawaysList');
        const endedList = document.getElementById('endedGiveawaysList');
        if (!activeList || !endedList) return;
        // נקה תוכן קודם
        activeList.innerHTML = active.length === 0 ? `<li><%= lang === 'en' ? 'No active giveaways.' : 'אין כרגע הגרלות פעילות.' %></li>` : '';
        endedList.innerHTML = ended.length === 0 ? `<li><%= lang === 'en' ? 'No giveaways have ended yet.' : 'אין עדיין הגרלות שהסתיימו.' %></li>` : '';
        // עבור כל הגרלה פעילה, הוסף לרשימה כפריט HTML
        active.forEach(g => {
          activeList.innerHTML += `
            <li>
              <strong>🎁 ${g.prize}</strong> | זוכים: ${g.winnerCount} | מסתיימת: ${new Date(g.endAt).toLocaleString('he-IL')}
              <form method="POST" action="/reroll-giveaway/${g.messageId}" style="display:inline;">
                <button class="button small reroll">🎲 רירול</button>
              </form>
              <form method="POST" action="/end-giveaway/${g.messageId}" style="display:inline;">
                <button class="button small end">⛔ סיום</button>
              </form>
              <button type="button" class="button small extend" data-id="${g.messageId}">⌛ הארך</button>
            </li>`;
        });
        // עבור הגרלות שהסתיימו, הוסף לרשימה כולל כפתורי רירול ומחיקה
        ended.forEach(g => {
          const winners = Array.isArray(g.winnerNames) && g.winnerNames.length > 0 ? g.winnerNames.join(', ') : g.winnerCount;
          endedList.innerHTML += `
            <li>
              <strong>🎁 ${g.prize}</strong> | זוכים: ${winners} | הסתיימה: ${new Date(g.endAt).toLocaleString('he-IL')}
              <form method="POST" action="/reroll-giveaway/${g.messageId}" style="display:inline;">
                <button class="button small reroll">🎲 רירול</button>
              </form>
              <form method="POST" action="/delete-giveaway" style="display:inline;">
                <input type="hidden" name="giveawayId" value="${g.messageId}">
                <button class="button small delete">🗑️ מחק</button>
              </form>
            </li>`;
        });
      });
    });
  </script>
</body>
</html>
